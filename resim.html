<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Dinamik Resim</title>
    
    <!-- Discord için kritik meta tag'lar - Statik değerler -->
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="Dinamik Resim">
    <meta property="og:title" id="og-title" content="Dinamik Resim">
    <meta property="og:description" id="og-description" content="Özel metin ile oluşturulmuş resim">
    
    <!-- Discord'un resim olarak algılaması için özel header -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Resim meta tag'ları - Discord için optimize -->
    <meta property="og:image" id="og-image" content="">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="800">
    <meta property="og:image:height" content="400">
    <meta property="og:image:alt" id="og-image-alt" content="Dinamik oluşturulmuş resim">
    <meta property="og:image:secure_url" id="og-image-secure" content="">
    
    <!-- Twitter Card - Discord tarafından da kullanılır -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" id="twitter-title" content="Dinamik Resim">
    <meta name="twitter:description" id="twitter-description" content="Özel metin ile oluşturulmuş resim">
    <meta name="twitter:image" id="twitter-image" content="">
    <meta name="twitter:image:alt" id="twitter-image-alt" content="Dinamik oluşturulmuş resim">
    
    <!-- Discord özel optimizasyonlar -->
    <meta name="theme-color" content="#667eea">
    <meta property="og:url" id="og-url" content="">
    <meta name="robots" content="index, follow, noimageindex">
    <link rel="canonical" id="canonical" href="">
    
    <!-- Discord'un resim olarak algılaması için HTTP header simülasyonu -->
    <meta http-equiv="Cache-Control" content="public, max-age=3600">
    <meta http-equiv="Expires" content="">
    
    <!-- Resim dosyası gibi davranması için ek meta tag'lar -->
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta property="og:locale" content="tr_TR">
    <style>
        /* Discord embed için optimize edilmiş stil */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 800px;
            height: 400px;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: transparent;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
        }
        
        canvas {
            display: block;
            width: 800px;
            height: 400px;
            border: none;
            outline: none;
        }
        
        /* Discord bot'ları için gizli resim elementi */
        .discord-image {
            position: absolute;
            top: -9999px;
            left: -9999px;
            width: 800px;
            height: 400px;
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Discord için ana canvas -->
    <canvas id="canvas" width="800" height="400"></canvas>
    
    <!-- Discord bot'ları için gizli resim elementi (otomatik oluşturulacak) -->
    
    <script>
        // URL parametrelerini al
        const urlParams = new URLSearchParams(window.location.search);
        const text = decodeURIComponent(urlParams.get('text') || 'Merhaba Dünya!');
        const fontSize = parseInt(urlParams.get('size') || '40');
        const color = decodeURIComponent(urlParams.get('color') || '#ffffff');
        const font = decodeURIComponent(urlParams.get('font') || 'Arial');
        const weight = urlParams.get('weight') || 'bold';
        const posX = parseInt(urlParams.get('x') || '400');
        const posY = parseInt(urlParams.get('y') || '200');
        const shadowBlur = parseInt(urlParams.get('shadowBlur') || '4');
        const shadowOffset = parseInt(urlParams.get('shadowOffset') || '2');
        const shadowColor = decodeURIComponent(urlParams.get('shadowColor') || '#000000');
        const templateId = urlParams.get('template');
        const bgUrl = urlParams.get('bg');
        console.log('URL\'den alınan bg parametresi:', bgUrl);
        
        // Meme template'leri - Imgflip API'sinden dinamik yükleme
        let memeTemplates = {};
        
        // Imgflip API'sinden template'leri yükle
        async function loadMemeTemplates() {
            try {
                console.log('Imgflip API\'den meme template\'leri yükleniyor...');
                const response = await fetch('https://api.imgflip.com/get_memes');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.memes) {
                        // API'den gelen meme'leri ID-URL eşlemesi olarak kaydet
                        data.data.memes.forEach(meme => {
                            memeTemplates[meme.id] = meme.url;
                        });
                        
                        console.log(`${Object.keys(memeTemplates).length} meme template Imgflip'ten yüklendi`);
                        return true;
                    }
                }
                throw new Error('API response hatası');
            } catch (error) {
                console.warn('Imgflip API hatası, yerel template\'ler kullanılıyor:', error);
                // API başarısız olursa yerel template'leri kullan
                memeTemplates = {
                    '181913649': 'https://i.imgflip.com/30b1gx.jpg',
                    '87743020': 'https://i.imgflip.com/1g8my4.jpg',
                    '112126428': 'https://i.imgflip.com/1ur9b0.jpg',
                    '131087935': 'https://i.imgflip.com/261o3j.jpg',
                    '4087833': 'https://i.imgflip.com/2fm6x.jpg',
                    '61579': 'https://i.imgflip.com/1bij.jpg',
                    '101470': 'https://i.imgflip.com/26am.jpg',
                    '80707627': 'https://i.imgflip.com/1c1uej.jpg',
                    '178591752': 'https://i.imgflip.com/2ybua0.jpg',
                    '27813981': 'https://i.imgflip.com/gk5el.jpg',
                    '124822590': 'https://i.imgflip.com/22bdq6.jpg',
                    '129242436': 'https://i.imgflip.com/24y43o.jpg',
                    '222403160': 'https://i.imgflip.com/3oevdk.jpg',
                    '91538330': 'https://i.imgflip.com/1ihzfe.jpg',
                    '102156234': 'https://i.imgflip.com/1otk96.jpg',
                    '93895088': 'https://i.imgflip.com/1jwhww.jpg',
                    '135256802': 'https://i.imgflip.com/28j0te.jpg',
                    '114585149': 'https://i.imgflip.com/1w7ygt.jpg',
                    '161865971': 'https://i.imgflip.com/2odckz.jpg',
                    '97984': 'https://i.imgflip.com/23ls.jpg'
                };
                return false;
            }
        }
        
        let backgroundImageUrl = null;
        // Önce özel arka plan URL'sini kontrol et
        if (bgUrl) {
            backgroundImageUrl = decodeURIComponent(bgUrl);
            console.log('Özel arka plan URL\'si kullanılıyor:', backgroundImageUrl);
        }
        
        // Canvas ve context
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let backgroundImage = null;
        
        function drawImage() {
            // Canvas'ı temizle
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Arka plan çiz
            if (backgroundImage) {
                // Template/özel resim arka planı
                ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
            } else {
                // Gradient arka plan
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Çoklu metin desteği - URL'den t0_, t1_, t2_ parametrelerini oku
            const textBoxes = [];
            
            // Önce çoklu metin parametrelerini kontrol et
            let index = 0;
            let hasMultipleTexts = false;
            
            while (true) {
                const textParam = urlParams.get(`t${index}_text`);
                if (!textParam) break;
                
                hasMultipleTexts = true;
                textBoxes.push({
                    text: decodeURIComponent(textParam),
                    x: parseInt(urlParams.get(`t${index}_x`) || '400'),
                    y: parseInt(urlParams.get(`t${index}_y`) || '200'),
                    fontSize: parseInt(urlParams.get(`t${index}_size`) || '40'),
                    color: decodeURIComponent(urlParams.get(`t${index}_color`) || '#ffffff'),
                    font: decodeURIComponent(urlParams.get(`t${index}_font`) || 'Impact'),
                    weight: urlParams.get(`t${index}_weight`) || 'bold',
                    shadowBlur: parseInt(urlParams.get(`t${index}_shadowBlur`) || '4'),
                    shadowOffset: parseInt(urlParams.get(`t${index}_shadowOffset`) || '2'),
                    shadowColor: decodeURIComponent(urlParams.get(`t${index}_shadowColor`) || '#000000')
                });
                index++;
            }
            
            // Eğer çoklu metin yoksa, ana metin parametrelerini kullan (geriye uyumluluk)
            if (!hasMultipleTexts && text) {
                textBoxes.push({
                    text: text,
                    x: posX,
                    y: posY,
                    fontSize: fontSize,
                    color: color,
                    font: font,
                    weight: weight,
                    shadowBlur: shadowBlur,
                    shadowOffset: shadowOffset,
                    shadowColor: shadowColor
                });
            }
            
            // Tüm metin kutularını çiz
            textBoxes.forEach(box => {
                if (!box.text.trim()) return;
                
                // Meme stili metin kontrolü
                if (box.font === 'Impact' || box.font === 'Arial Black') {
                    // Meme stili: beyaz metin + siyah kontur
                    ctx.strokeStyle = '#000000';
                    ctx.lineWidth = Math.max(2, box.fontSize / 15);
                    ctx.font = `${box.weight} ${box.fontSize}px ${box.font}`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    const lines = box.text.split('\n');
                    const lineHeight = box.fontSize * 1.1;
                    const startY = box.y - ((lines.length - 1) * lineHeight) / 2;

                    lines.forEach((line, index) => {
                        const y = startY + (index * lineHeight);
                        ctx.strokeText(line, box.x, y);
                    });

                    // Metin çiz
                    ctx.fillStyle = box.color;
                    lines.forEach((line, index) => {
                        const y = startY + (index * lineHeight);
                        ctx.fillText(line, box.x, y);
                    });
                } else {
                    // Normal metin (gölge ile)
                    ctx.font = `${box.weight} ${box.fontSize}px ${box.font}`;
                    ctx.fillStyle = box.color;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // Gölge ayarları (kutu parametrelerinden)
                    ctx.shadowColor = box.shadowColor || 'rgba(0, 0, 0, 0.5)';
                    ctx.shadowBlur = box.shadowBlur || 4;
                    ctx.shadowOffsetX = box.shadowOffset || 2;
                    ctx.shadowOffsetY = box.shadowOffset || 2;
                    
                    // Metni çiz (çok satırlı destek)
                    const lines = box.text.split('\n');
                    const lineHeight = box.fontSize * 1.2;
                    const startY = box.y - ((lines.length - 1) * lineHeight) / 2;
                    
                    lines.forEach((line, index) => {
                        ctx.fillText(line, box.x, startY + (index * lineHeight));
                    });
                }
                
                // Gölgeyi temizle (diğer metinleri etkilemesin)
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            });
        }
        
        function loadBackgroundImage() {
            if (!backgroundImageUrl) {
                console.log('Arka plan resmi yok, gradient kullanılıyor');
                drawImage();
                setTimeout(updateMetaTags, 100);
                return;
            }
            
            console.log('Arka plan resmi yükleniyor:', backgroundImageUrl);
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                console.log('Arka plan resmi başarıyla yüklendi');
                backgroundImage = img;
                drawImage();
                setTimeout(updateMetaTags, 100);
            };
            img.onerror = function() {
                console.error('Arka plan resmi yüklenemedi:', backgroundImageUrl);
                console.log('Gradient arka plan kullanılıyor');
                backgroundImage = null; // Resim yüklenemezse null yap
                drawImage();
                setTimeout(updateMetaTags, 100);
            };
            img.src = backgroundImageUrl;
        }
        
        function updateMetaTags() {
            // Resmi PNG olarak al (maksimum kalite)
            const imageDataUrl = canvas.toDataURL('image/png', 1.0);
            const currentUrl = window.location.href;
            const shortText = text.substring(0, 50) + (text.length > 50 ? '...' : '');
            const description = `"${shortText}" metni ile oluşturulmuş dinamik resim`;
            
            // Title güncelle
            document.title = shortText;
            document.getElementById('page-title').textContent = shortText;
            
            // Open Graph meta tag'ları güncelle
            document.getElementById('og-title').setAttribute('content', shortText);
            document.getElementById('og-description').setAttribute('content', description);
            document.getElementById('og-image').setAttribute('content', imageDataUrl);
            document.getElementById('og-image-secure').setAttribute('content', imageDataUrl);
            document.getElementById('og-image-alt').setAttribute('content', description);
            document.getElementById('og-url').setAttribute('content', currentUrl);
            
            // Twitter meta tag'ları güncelle
            document.getElementById('twitter-title').setAttribute('content', shortText);
            document.getElementById('twitter-description').setAttribute('content', description);
            document.getElementById('twitter-image').setAttribute('content', imageDataUrl);
            document.getElementById('twitter-image-alt').setAttribute('content', description);
            
            // Canonical URL
            document.getElementById('canonical').setAttribute('href', currentUrl);
            
            // Expires header simülasyonu
            const expires = new Date();
            expires.setHours(expires.getHours() + 1);
            document.querySelector('meta[http-equiv="Expires"]').setAttribute('content', expires.toUTCString());
            
            // Favicon olarak da ayarla
            let favicon = document.querySelector('link[rel="icon"]');
            if (!favicon) {
                favicon = document.createElement('link');
                favicon.rel = 'icon';
                document.head.appendChild(favicon);
            }
            favicon.href = imageDataUrl;
            
            // Discord için gizli resim elementi oluştur
            createHiddenImageElement(imageDataUrl);
            
            // HTTP response header'ları simüle et
            simulateImageHeaders();
        }
        
        function createHiddenImageElement(dataUrl) {
            // Mevcut gizli resmi kaldır
            const existingImg = document.querySelector('.discord-image');
            if (existingImg) {
                existingImg.remove();
            }
            
            // Yeni gizli resim elementi oluştur
            const img = document.createElement('img');
            img.className = 'discord-image';
            img.src = dataUrl;
            img.alt = text;
            img.width = 800;
            img.height = 400;
            document.body.appendChild(img);
        }
        
        function simulateImageHeaders() {
            // Discord'un resim olarak algılaması için HTTP header simülasyonu
            const head = document.head;
            
            // Content-Type meta tag'ı ekle
            let contentType = document.querySelector('meta[http-equiv="Content-Type"]');
            if (contentType) {
                contentType.setAttribute('content', 'image/png');
            }
            
            // Cache-Control optimizasyonu
            let cacheControl = document.querySelector('meta[http-equiv="Cache-Control"]');
            if (cacheControl) {
                cacheControl.setAttribute('content', 'public, max-age=3600, immutable');
            }
        }
        
        // Discord embed optimizasyonu için özel başlatma
        async function initializeForDiscord() {
            console.log('=== BAŞLATMA DURUMU ===');
            console.log('templateId:', templateId);
            console.log('bgUrl:', bgUrl);
            console.log('backgroundImageUrl (başlangıç):', backgroundImageUrl);
            
            // Önce meme template'leri yükle
            await loadMemeTemplates();
            
            // Template ID'si varsa URL'yi güncelle (sadece özel URL yoksa)
            if (templateId && memeTemplates[templateId] && !bgUrl) {
                backgroundImageUrl = memeTemplates[templateId];
                console.log('Template arka planı kullanılıyor:', backgroundImageUrl);
            }
            
            console.log('backgroundImageUrl (son):', backgroundImageUrl);
            
            // Arka plan resmi varsa yükle, yoksa direkt çiz
            if (backgroundImageUrl) {
                console.log('Arka plan resmi yüklenecek:', backgroundImageUrl);
                loadBackgroundImage();
            } else {
                console.log('Arka plan resmi yok, gradient çizilecek');
                drawImage();
                setTimeout(updateMetaTags, 100);
            }
            
            // Discord bot'ları için ek optimizasyon
            setTimeout(() => {
                // Sayfa başlığını resim içeriğine göre ayarla
                document.title = text || 'Dinamik Resim';
                
                // Body'yi resim gibi davranacak şekilde ayarla
                document.body.style.background = 'transparent';
                document.body.style.width = '800px';
                document.body.style.height = '400px';
                
            }, 50);
        }
        
        // Sayfa yüklendiğinde Discord optimizasyonunu başlat
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeForDiscord);
        } else {
            initializeForDiscord();
        }
        
        // Sayfa tamamen yüklendiğinde de güncelle
        window.addEventListener('load', () => {
            setTimeout(updateMetaTags, 100);
        });
        
        // Discord bot'ları için User-Agent kontrolü
        const userAgent = navigator.userAgent.toLowerCase();
        if (userAgent.includes('discord') || userAgent.includes('bot')) {
            // Discord bot'u algılandı, özel optimizasyonlar
            document.body.style.margin = '0';
            document.body.style.padding = '0';
            document.body.style.overflow = 'hidden';
        }
    </script>
</body>
</html>